name: Build macOS App

on: [push]

jobs:
  build-mac:
    runs-on: macos-latest
    timeout-minutes: 20
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        # 安装必要工具
        npm install node-fetch@2.6.7 --save
        
        # 运行自定义安装脚本
        node scripts/preinstall.js
        
        # 安装其他依赖
        npm install nw-builder@3.6.0 --save-dev
        npm install
        
    - name: Build application
      run: |
        npx nwbuild \
          --nwVersion=0.76.1 \
          --flavor=normal \
          --platform=osx64 \
          --cacheDir=./nw-cache \
          -o ./dist \
          ./
          
    - name: Verify build
      run: |
        if [ -d "./dist/my-app/osx64" ]; then
          echo "Build successful! Contents:"
          ls -la "./dist/my-app/osx64/"
        else
          echo "Build failed! Debug info:"
          echo "Project structure:"
          find . -maxdepth 3 -type d
          exit 1
        fi
        
    - name: Create ZIP package
      run: |
        cd ./dist/my-app/osx64/
        zip -r ../my-app-mac.zip .
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: my-app-mac
        path: ./dist/my-app/my-app-mac.zip